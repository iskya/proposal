name: "Geant4 Simulation"

on:
  workflow_dispatch:
    inputs:
      request_file:
        description: 'Request YAML (e.g. requests/full_classification.yaml)'
        required: true
        type: string
      events_per_config:
        description: 'Events per (material x momentum). 0 = use YAML value'
        required: false
        default: '2000'
        type: string

permissions:
  contents: write

jobs:
  simulate:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash -el {0}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Conda (Miniforge)
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          activate-environment: g4sim
          python-version: "3.11"
          channels: conda-forge
          channel-priority: strict

      - name: Install Geant4 and dependencies
        run: |
          conda install -y geant4=11.3.2 cmake make compilers numpy matplotlib scipy pyyaml

      - name: Verify Geant4
        run: |
          geant4-config --version
          geant4-config --prefix
          echo "Geant4_DIR=$(geant4-config --prefix)/lib/cmake/Geant4"
          python3 -c "import numpy, matplotlib, scipy, yaml; print('Python deps OK')"

      - name: Build BeamScan
        run: |
          G4DIR="$(geant4-config --prefix)/lib/cmake/Geant4"
          # Fall back to searching if standard path doesn't have it
          if [[ ! -f "$G4DIR/Geant4Config.cmake" ]]; then
            G4DIR="$(dirname "$(find "$(geant4-config --prefix)" -name Geant4Config.cmake | head -1)")"
          fi
          echo "Using Geant4_DIR=$G4DIR"
          cmake -S simulation -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DGeant4_DIR="$G4DIR"
          cmake --build build -j"$(nproc)"
          ls -la build/beamscan

      - name: Generate macros
        run: |
          python3 scripts/generate_macros.py "${{ inputs.request_file }}" \
            --output-dir macros_auto \
            --results-dir geant4_output \
            --events-per-config "${{ inputs.events_per_config }}"

      - name: Run Geant4
        run: |
          export BEAMSCAN_BIN=./build/beamscan
          bash macros_auto/run_all.sh

      - name: Highland comparison
        run: |
          mkdir -p comparison/highland comparison/geant4_vs_highland
          python3 analysis/highland_calculator.py "${{ inputs.request_file }}" \
            --output-dir comparison/highland
          python3 analysis/analyze_geant4.py geant4_output/ \
            --highland-dir comparison/highland \
            --output-dir comparison/geant4_vs_highland || \
          echo "Warning: Geant4 analysis had issues (may be OK)"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: geant4-${{ github.run_id }}
          path: |
            geant4_output/
            comparison/
            macros_auto/
          retention-days: 60

      - name: Commit comparison results
        run: |
          # Copy comparison outputs into repo (not the raw geant4_output — too large)
          mkdir -p results/geant4_comparison
          cp -r comparison/highland/* results/geant4_comparison/ 2>/dev/null || true
          cp -r comparison/geant4_vs_highland/* results/geant4_comparison/ 2>/dev/null || true

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add results/geant4_comparison/
          git diff --cached --quiet || git commit -m "⚛️ Update Geant4 vs Highland comparison [skip ci]"
          git pull --rebase origin main
          git push
