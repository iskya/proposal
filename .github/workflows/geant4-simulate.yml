# ═══════════════════════════════════════════════════════════════
# BeamScan -- Geant4 Monte Carlo (Docker on GitHub-hosted runner)
# ═══════════════════════════════════════════════════════════════
# Uses JeffersonLab's pre-built Geant4 Docker image.
# GitHub Actions overrides the container entrypoint, so we must
# locate Geant4 ourselves and source the environment script.
# ═══════════════════════════════════════════════════════════════

name: "Geant4 Simulation"

on:
  workflow_dispatch:
    inputs:
      request_file:
        description: 'Request YAML (e.g. requests/full_classification.yaml)'
        required: true
        type: string
      events_per_config:
        description: 'Events per (material x momentum). 0 = use YAML value'
        required: false
        default: '2000'
        type: string

permissions:
  contents: read

jobs:
  simulate:
    runs-on: ubuntu-latest
    container:
      image: jeffersonlab/geant4:g4v11.3.2-fedora40

    steps:
      - uses: actions/checkout@v4

      - name: Locate Geant4 and export environment
        id: g4env
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Searching for Geant4 ==="

          # 1) Find geant4-config anywhere
          G4CFG="$(command -v geant4-config 2>/dev/null || true)"
          if [[ -z "$G4CFG" ]]; then
            G4CFG="$(find / -type f -name geant4-config 2>/dev/null | head -1 || true)"
          fi

          if [[ -n "$G4CFG" ]]; then
            echo "Found geant4-config: $G4CFG"
            echo "$(dirname "$G4CFG")" >> "$GITHUB_PATH"
            # Source the env script next to it
            G4SH="$(dirname "$G4CFG")/geant4.sh"
            if [[ -f "$G4SH" ]]; then
              source "$G4SH"
              echo "Sourced $G4SH"
            fi
            G4CMAKE="$("$G4CFG" --cmakedir 2>/dev/null || true)"
          fi

          # 2) If geant4-config didn't give us cmake dir, find it
          if [[ -z "${G4CMAKE:-}" ]]; then
            echo "Searching for Geant4Config.cmake..."
            G4CMAKE="$(dirname "$(find / -type f -name Geant4Config.cmake 2>/dev/null | head -1)" 2>/dev/null || true)"
          fi

          if [[ -z "${G4CMAKE:-}" ]]; then
            echo "ERROR: Geant4Config.cmake not found anywhere in container."
            echo "Debug info:"
            find / -maxdepth 4 -name "geant4*" -type d 2>/dev/null || true
            exit 1
          fi

          echo "Geant4_DIR=$G4CMAKE"
          echo "Geant4_DIR=$G4CMAKE" >> "$GITHUB_ENV"

          # 3) Find and source geant4.sh for data paths
          G4SH="$(find / -type f -name geant4.sh -path "*/bin/*" 2>/dev/null | head -1 || true)"
          if [[ -n "$G4SH" ]]; then
            # Write a sourceable env file for later steps
            source "$G4SH"
            echo "G4_ENV_SCRIPT=$G4SH" >> "$GITHUB_ENV"
            echo "Sourced env from: $G4SH"
            env | grep -i "^G4" | sort
          fi

          echo "=== Geant4 ready ==="

      - name: Build BeamScan
        shell: bash
        run: |
          set -euo pipefail
          [[ -n "${G4_ENV_SCRIPT:-}" ]] && source "$G4_ENV_SCRIPT"
          cmake -S simulation -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DGeant4_DIR="${Geant4_DIR}"
          cmake --build build -j"$(nproc)"
          ls -la build/beamscan

      - name: Install Python deps
        shell: bash
        run: |
          python3 -m pip --version 2>/dev/null || python3 -m ensurepip --upgrade
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml numpy matplotlib scipy

      - name: Generate macros
        shell: bash
        run: |
          python3 scripts/generate_macros.py "${{ inputs.request_file }}" \
            --output-dir macros_auto \
            --results-dir geant4_output \
            --events-per-config "${{ inputs.events_per_config }}"

      - name: Run Geant4
        shell: bash
        run: |
          [[ -n "${G4_ENV_SCRIPT:-}" ]] && source "$G4_ENV_SCRIPT"
          export BEAMSCAN_BIN=./build/beamscan
          bash macros_auto/run_all.sh

      - name: Highland comparison
        shell: bash
        run: |
          mkdir -p comparison/highland comparison/geant4_vs_highland
          python3 analysis/highland_calculator.py "${{ inputs.request_file }}" \
            --output-dir comparison/highland
          python3 analysis/analyze_geant4.py geant4_output/ \
            --highland-dir comparison/highland \
            --output-dir comparison/geant4_vs_highland || \
          echo "Warning: Geant4 analysis had issues (may be OK)"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: geant4-${{ github.run_id }}
          path: |
            geant4_output/
            comparison/
            macros_auto/
          retention-days: 60
